version: '3'

services:

  dks:
    image: dks
    ports:
      - 8443:8443
    build:
      context: docker/dks
    environment:
      - SPRING_PROFILES_ACTIVE=STANDALONE,SECURE
      - SPRING_CONFIG_LOCATION=application-secure.properties
    container_name: dks

  dks-insecure:
    image: dks
    ports:
      - 8080:8080
    build:
      context: docker/dks
    container_name: dks-insecure
    environment:
      - SPRING_PROFILES_ACTIVE=STANDALONE,INSECURE

  hbase:
    image: harisekhon/hbase:1.4
    ports:
      - 9090:9090
      - 9095:9095
      - 2181:2181
      - 16201:16201
    container_name: hbase

  s3:
    image: localstack/localstack
    ports:
      - '4563-4584:4563-4584'
      - '8055:8080'
    environment:
      - SERVICES=s3
      - DEBUG=1
      - DATA_DIR=/data/s3
    container_name: s3

  s3-init:
    image: s3-init
    build:
      context: docker/s3-init
    container_name: s3-init
    depends_on:
      - s3
    environment:
      - S3_SERVICE_ENDPOINT=http://s3:4572
      - AWS_REGION=eu-west-2
      - AWS_ACCESS_KEY_ID=aws-access-key
      - AWS_SECRET_ACCESS_KEY=aws-secret-access-key
      - S3_BUCKET=uc-historic-data
      - S3_PREFIX=test/prefix/

  uc-historic-data-importer:
    image: uc-historic-data-importer
    build:
      context: .
      args:
        - APP_VERSION
    depends_on:
      - hbase
      - s3-init
    container_name: uc-historic-data-importer
    command: >-
      --aws.region=eu-west-2
      --aws.access.key=aws-access-key
      --aws.secret.key=aws-secret-key
      --s3.bucket=uc-historic-data
      --s3.prefix.folder=test/prefix/
      --s3.service.endpoint=http://s3:4572
      --spring.profiles.active=localS3,secureHttpClient,batchRun
      --s3.key.regex=([A-Za-z]*\\.[A-Za-z]*\\.[0-9]{4}\\.json\\.gz)
      --s3.data.key.extension=\\.enc$$
      --s3.metadata.key.extension=\\.encryption\\.json$$
      --thread.count=10
